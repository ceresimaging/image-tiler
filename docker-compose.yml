version: "3"

networks:
  ceres-dev:
    external: true

volumes:
  minio-storage:
    driver: local

services:
  tiler:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - ENV=development
    volumes:
      - .:/srv/tiler
    ports:
      - 8888:80
      - 9229:9229
    working_dir: /srv/tiler
    command: npm run dev
    env_file: .env
    environment:
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}
      - AWS_S3_ENDPOINT=minio-tiler:9000
      - AWS_VIRTUAL_HOSTING=FALSE
      - AWS_HTTPS=NO
      - GDAL_DISABLE_READDIR_ON_OPEN=YES
    links:
      - minio-tiler
    networks:
      - default
      - ceres-dev

  minio-tiler:
    image: minio/minio:RELEASE.2019-06-04T01-15-58Z
    volumes:
      - minio-storage:/minio/cache
    environment:
      - MINIO_ACCESS_KEY=${AWS_ACCESS_KEY_ID}
      - MINIO_SECRET_KEY=${AWS_SECRET_ACCESS_KEY}
      - MINIO_ROOT_USER=${AWS_ACCESS_KEY_ID}
      - MINIO_ROOT_PASSWORD=${AWS_SECRET_ACCESS_KEY}
      - MINIO_CACHE=on
      - MINIO_CACHE_AFTER=1
      - MINIO_CACHE_DRIVES=/minio/cache
    command: gateway s3
    ports:
      - 9999:9000
    networks:
      - default
      - ceres-dev
