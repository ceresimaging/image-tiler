version: "3"

networks:
  ceres-dev:
    external: true

services:
  tiler:
    build:
      context: .
      dockerfile: Dockerfile
      args:
        - ENV=development
    volumes:
      - .:/srv/tiler
    ports:
      - 8888:80
      - 9229:9229
    working_dir: /srv/tiler
    command: npm run dev
    env_file: .env
    environment:
      - AWS_ACCESS_KEY_ID=${AWS_ACCESS_KEY_ID}
      - AWS_SECRET_ACCESS_KEY=${AWS_SECRET_ACCESS_KEY}
      - AWS_DEFAULT_REGION=${AWS_DEFAULT_REGION}
      - AWS_S3_ENDPOINT=minio-tiler:9000
      - AWS_VIRTUAL_HOSTING=FALSE
      - AWS_HTTPS=NO
      - GDAL_DISABLE_READDIR_ON_OPEN=EMPTY_DIR
      - LOG_REQUESTS=TRUE
    links:
      - minio-tiler
    networks:
      - default
      - ceres-dev

  minio-tiler:
    image: minio/minio
    tmpfs: /minio/cache:size=1G
    environment:
      - MINIO_ROOT_USER=${AWS_ACCESS_KEY_ID}
      - MINIO_ROOT_PASSWORD=${AWS_SECRET_ACCESS_KEY}
      - MINIO_CACHE=on
      - MINIO_CACHE_AFTER=1
      - MINIO_CACHE_DRIVES=/minio/cache
      - MINIO_BROWSER=off
    command: gateway s3
    networks:
      - default
      - ceres-dev
